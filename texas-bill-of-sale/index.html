<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TX Firearm Bill of Sale (Free PWA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .sig-pad { border: 2px dashed #94a3b8; background-color: #f8fafc; touch-action: none; width: 100%; height: 150px; border-radius: 0.5rem; }
        .input-group { margin-bottom: 1rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem; color: #334155; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 1rem; }
        .section-header { background-color: #0f172a; color: white; padding: 0.75rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; border-radius: 0.375rem; display: flex; align-items: center; }
        .legal-list { list-style-type: none; margin-left: 0; font-size: 0.8rem; color: #475569; }
        .legal-list li { margin-bottom: 0.5rem; padding-left: 1.5rem; position: relative; }
        .legal-list li::before { content: "âœ“"; color: #22c55e; position: absolute; left: 0; font-weight: bold; }
        #successModal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-20">

    <div class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <span class="font-bold text-slate-900">ReadyMyHome.org</span>
            <a href="/" class="text-xs text-blue-600 font-bold">Exit</a>
        </div>
    </div>

    <div class="max-w-md mx-auto bg-white p-6 shadow-xl min-h-screen">
        
        <h1 class="text-2xl font-extrabold text-center mb-1 text-slate-900">Texas Bill of Sale</h1>
        <div class="flex justify-center items-center space-x-2 text-xs text-green-600 mb-6 font-bold bg-green-50 py-1 rounded-full w-fit mx-auto px-4">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <span>Secure Client-Side Encryption</span>
        </div>

        <div id="adSlotTop" class="mb-8 p-3 bg-blue-50 border border-blue-100 rounded-lg text-center hidden">
            <p class="text-[10px] text-gray-400 uppercase tracking-wide font-bold mb-1">Sponsored</p>
            <a id="adLinkTop" href="#" target="_blank" class="text-sm text-blue-800 font-bold hover:underline block"></a>
        </div>

        <form id="bosForm">
            <div class="section-header"><span>1. Seller Information</span></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="sellerName" placeholder="Legal Name"></div>
            <div class="input-group"><label>DL / LTC Number</label><input type="text" id="sellerDL"></div>
            <div class="input-group"><label>Address (City, State)</label><input type="text" id="sellerAddr" placeholder="Austin, TX"></div>

            <div class="section-header"><span>2. Buyer Information</span></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="buyerName" placeholder="Legal Name"></div>
            <div class="input-group"><label>DL / LTC Number</label><input type="text" id="buyerDL"></div>
            <div class="input-group"><label>Address (City, State)</label><input type="text" id="buyerAddr" placeholder="Houston, TX"></div>

            <div class="section-header"><span>3. Firearm Details</span></div>
            <div class="input-group"><label>Make</label><input type="text" id="gunMake" placeholder="e.g. Glock"></div>
            <div class="input-group"><label>Model</label><input type="text" id="gunModel" placeholder="e.g. 19 Gen 5"></div>
            <div class="input-group"><label>Caliber</label><input type="text" id="gunCaliber" placeholder="e.g. 9mm"></div>
            <div class="input-group"><label>Serial Number</label><input type="text" id="gunSerial"></div>
            <div class="input-group"><label>Sale Price ($)</label><input type="number" id="salePrice" placeholder="0.00"></div>

            <div class="section-header"><span>4. Documentation</span></div>
            <div class="input-group">
                <label>Photo of Firearm / Serial</label>
                <input type="file" id="photoGun" accept="image/*" capture="environment" class="text-sm">
            </div>
            <div class="input-group">
                <label>Photo of Buyer ID (Optional)</label>
                <input type="file" id="photoID" accept="image/*" capture="environment" class="text-sm">
            </div>

            <div class="section-header"><span>5. Certifications</span></div>
            <p class="text-sm font-bold mb-3">Buyer Certification:</p>
            <ul class="legal-list">
                <li>I am not prohibited by law from owning a firearm.</li>
                <li>I have never been convicted of a felony > 1 year.</li>
                <li>I am not a fugitive from justice.</li>
                <li>I am not an unlawful user of controlled substances.</li>
                <li>I have never been adjudicated mentally defective.</li>
                <li>I am not an illegal alien.</li>
                <li>I have not been dishonorably discharged.</li>
                <li>I am not subject to a domestic restraining order.</li>
                <li>I have not been convicted of domestic violence.</li>
            </ul>

            <div class="mt-6">
                <label>Seller Signature</label>
                <canvas id="sellerCanvas" class="sig-pad"></canvas>
                <button type="button" class="text-xs text-red-500 font-bold mt-1" onclick="clearPad(sellerPad)">Clear</button>
            </div>

            <div class="mt-6">
                <label>Buyer Signature</label>
                <canvas id="buyerCanvas" class="sig-pad"></canvas>
                <button type="button" class="text-xs text-red-500 font-bold mt-1" onclick="clearPad(buyerPad)">Clear</button>
            </div>

            <div class="mt-10 mb-8">
                <button type="button" onclick="generatePDF()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg flex justify-center items-center transition transform active:scale-95">
                    <span>Generate Official PDF</span>
                </button>
            </div>
        </form>
    </div>

    <div id="successModal" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-green-500 p-4 text-center">
                <h2 class="text-white font-bold text-xl">Success!</h2>
                <p class="text-green-100 text-sm">File downloaded securely.</p>
            </div>
            
            <div class="p-6">
                <div class="bg-red-50 border border-red-100 p-4 rounded-xl mb-4 text-center">
                    <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-2">Recommended</p>
                    <h3 id="modalAdTitle" class="text-lg font-bold text-slate-800 mb-1">Protect Your Rights</h3>
                    <p id="modalAdText" class="text-sm text-slate-600 mb-4">Liability doesn't end at the sale. Get 24/7 legal protection.</p>
                    <a id="modalAdLink" href="#" target="_blank" class="block w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 shadow-md transition">
                        Check Offer
                    </a>
                </div>

                <button type="button" onclick="closeModal()" class="block w-full text-center text-slate-400 hover:text-slate-600 text-sm font-bold mt-4">
                    Close Window
                </button>
            </div>
        </div>
    </div>

    <div id="qrcode" style="display:none;"></div>

    <script>
        // --- 1. ADVERTISING INVENTORY ---
        const adConfig = {
            topBanner: {
                enabled: true,
                text: "Consider US Lawshield. Not a sponsor, but probably a good idea.",
                link: "https://www.uslawshield.com/" 
            },
            modalAd: {
                enabled: true,
                headline: "Stock Up & Stay Safe",
                subtext: "Find bulk ammo deals and secure storage solutions.",
                btnText: "Shop Palmetto State Armory",
                link: "https://palmettostatearmory.com/" 
            },
            pdfFooter: {
                enabled: true,
                text: "Need Ammo? Check Daily Deals at ReadyMyHome.org",
                link: "https://readymyhome.org"
            }
        };

        // --- 2. LOGIC START ---
        const APP_URL = "https://readymyhome.org/texas-bill-of-sale/";
        
        document.addEventListener("DOMContentLoaded", () => {
            if (adConfig.topBanner.enabled) {
                const banner = document.getElementById('adSlotTop');
                const link = document.getElementById('adLinkTop');
                link.innerText = adConfig.topBanner.text;
                link.href = adConfig.topBanner.link;
                banner.classList.remove('hidden');
            }
            if (adConfig.modalAd.enabled) {
                document.getElementById('modalAdTitle').innerText = adConfig.modalAd.headline;
                document.getElementById('modalAdText').innerText = adConfig.modalAd.subtext;
                document.getElementById('modalAdLink').innerText = adConfig.modalAd.btnText;
                document.getElementById('modalAdLink').href = adConfig.modalAd.link;
            }
        });

        // --- 3. CORE FUNCTIONS ---
        const qrContainer = document.getElementById("qrcode");
        new QRCode(qrContainer, { text: APP_URL, width: 100, height: 100 });

        const sellerCanvas = document.getElementById('sellerCanvas');
        const buyerCanvas = document.getElementById('buyerCanvas');
        
        function resizeCanvas(canvas) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        window.onresize = function() { resizeCanvas(sellerCanvas); resizeCanvas(buyerCanvas); };
        resizeCanvas(sellerCanvas); resizeCanvas(buyerCanvas);

        const sellerPad = new SignaturePad(sellerCanvas);
        const buyerPad = new SignaturePad(buyerCanvas);

        function clearPad(pad) { pad.clear(); }
        function closeModal() { document.getElementById('successModal').classList.add('hidden'); }

        const getBase64 = (file) => {
            return new Promise((resolve, reject) => {
                if(!file) resolve(null);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        // --- 4. PDF GENERATION ---
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const sName = document.getElementById('sellerName').value || "_________________";
            const bName = document.getElementById('buyerName').value || "_________________";
            const gunInfo = `${document.getElementById('gunMake').value} ${document.getElementById('gunModel').value} (${document.getElementById('gunCaliber').value})`;
            const serial = document.getElementById('gunSerial').value || "_________________";
            const price = document.getElementById('salePrice').value;

            // HEADER
            doc.setFontSize(22);
            doc.text("Texas Firearm Bill of Sale", 105, 20, null, null, "center");
            doc.setFontSize(10);
            doc.text(`Date of Sale: ${new Date().toLocaleDateString()}`, 105, 28, null, null, "center");

            // SELLER / BUYER
            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35); 

            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("SELLER", 20, 42);
            doc.setFont("helvetica", "normal"); doc.setFontSize(10);
            doc.text(`Name: ${sName}`, 20, 48);
            doc.text(`DL/LTC: ${document.getElementById('sellerDL').value}`, 20, 54);
            doc.text(`Address: ${document.getElementById('sellerAddr').value}`, 20, 60);

            doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.text("BUYER", 110, 42);
            doc.setFont("helvetica", "normal"); doc.setFontSize(10);
            doc.text(`Name: ${bName}`, 110, 48);
            doc.text(`DL/LTC: ${document.getElementById('buyerDL').value}`, 110, 54);
            doc.text(`Address: ${document.getElementById('buyerAddr').value}`, 110, 60);

            doc.line(20, 65, 190, 65); 

            // FIREARM
            doc.setFont("helvetica", "bold"); doc.text("FIREARM DETAILS", 20, 72);
            doc.setFont("helvetica", "normal");
            doc.text(`Make/Model/Caliber: ${gunInfo}`, 20, 78);
            doc.text(`Serial Number: ${serial}`, 20, 84);
            if(price) doc.text(`Sale Price: $${price}`, 110, 84);
            doc.line(20, 88, 190, 88); 

            // LEGAL
            doc.setFont("helvetica", "bold"); doc.setFontSize(9);
            doc.text("BUYER CERTIFICATION & LEGAL STATEMENT", 20, 95);
            doc.setFont("helvetica", "normal"); doc.setFontSize(8);
            const legalText = [
                "The Buyer certifies they are not restricted or forbidden by law to own a firearm and states that he/she:",
                "- Has NEVER been convicted in any court of a crime punishable by imprisonment for a term exceeding 1 year.",
                "- Is NOT a fugitive from justice.",
                "- Is NOT an unlawful user of or addicted to any controlled substance.",
                "- Has NEVER been adjudicated as a mental defective or has been committed to a mental institution.",
                "- Is NOT an alien illegally or unlawfully in the United States.",
                "- Has NOT been discharged from the Armed Forces under dishonorable conditions.",
                "- Is NOT subject to a court order restraining them from harassing, stalking, or threatening an intimate partner/child.",
                "- Has NOT been convicted of a misdemeanor crime of domestic violence."
            ];
            let yLeg = 102;
            legalText.forEach(line => { doc.text(line, 20, yLeg); yLeg += 4; });

            doc.setFont("helvetica", "bold"); doc.text("SELLER STATEMENT:", 20, yLeg + 4);
            doc.setFont("helvetica", "normal");
            doc.text("I understand the firearm is sold AS-IS and no warranty has been implied or given.", 20, yLeg + 9);

            // SIGNATURES
            let ySig = yLeg + 20;
            doc.rect(20, ySig, 80, 25); doc.rect(110, ySig, 80, 25); 
            if (!sellerPad.isEmpty()) { doc.addImage(sellerPad.toDataURL(), 'PNG', 25, ySig + 2, 70, 20); }
            if (!buyerPad.isEmpty()) { doc.addImage(buyerPad.toDataURL(), 'PNG', 115, ySig + 2, 70, 20); }
            doc.text("Seller Signature", 20, ySig + 30); doc.text("Buyer Signature", 110, ySig + 30);

            // PHOTOS
            const gunPhoto = document.getElementById('photoGun').files[0];
            const idPhoto = document.getElementById('photoID').files[0];
            let yPhoto = ySig + 40;
            if (gunPhoto) {
                const imgData = await getBase64(gunPhoto);
                if(imgData) { doc.text("Attached Image: Firearm", 20, yPhoto); doc.addImage(imgData, 'JPEG', 20, yPhoto + 5, 80, 60); }
            }
            if (idPhoto) {
                const imgData = await getBase64(idPhoto);
                if(imgData) { doc.text("Attached Image: ID", 110, yPhoto); doc.addImage(imgData, 'JPEG', 110, yPhoto + 5, 80, 60); }
            }

            // FOOTER & QR
            doc.setFillColor(245, 245, 245); doc.rect(0, 270, 210, 30, 'F'); 
            doc.setFontSize(8); doc.setTextColor(100, 100, 100);
            doc.text("Generated securely by the TX-BOS PWA. No data was stored on any server.", 10, 278);
            
            // SMART LINK
            doc.setTextColor(220, 38, 38); doc.setFont("helvetica", "bold");
            doc.textWithLink(adConfig.pdfFooter.text, 10, 283, { url: adConfig.pdfFooter.link });

            const qrCanvas = document.querySelector("#qrcode canvas");
            if(qrCanvas) {
                const qrData = qrCanvas.toDataURL("image/png");
                doc.addImage(qrData, 'PNG', 175, 272, 25, 25);
                doc.link(175, 272, 25, 25, { url: APP_URL });
            }

            doc.save(`BillOfSale_${bName.replace(/ /g, "_")}.pdf`);
            document.getElementById('successModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
